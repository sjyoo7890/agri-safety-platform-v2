# FR-ALT: 알림 및 비상 대응 관리

## 모듈 개요
위험 등급별 다채널 알림 설정, 수신자 관리, E-Call 긴급 호출 관리, 알림 이력 조회, 에스컬레이션 규칙을 관리하는 모듈.

## 접근 권한
- 시스템 관리자: 전체 알림 규칙/이력 관리
- 농장 관리자: 소속 농장 알림 규칙 설정, 이력 조회
- 작업자: 모바일 웹에서 알림 수신 및 E-Call 발동 (FR-MOB 연동)

## 기능 요구사항

| ID | 요구사항 | 우선순위 | 상세 설명 |
|----|---------|---------|----------|
| FR-ALT-001 | 다채널 알림 설정 | 상 | 위험 등급별(관심/주의/경계/심각) 알림 채널(SMS, 앱 푸시, 스마트조끼 진동/소리, 현장 경광등) 매핑 설정 |
| FR-ALT-002 | 알림 수신자 관리 | 상 | 위험 유형 및 등급별 알림 수신자(작업자, 관리자, 보호자, 119) 그룹 설정 |
| FR-ALT-003 | E-Call 관리 | 상 | 긴급 상황 시 자동 E-Call 발동 조건 설정 및 이력 관리. 위치 정보 포함 자동 구조 요청 메시지 생성 |
| FR-ALT-004 | 알림 이력 조회 | 상 | 전체 알림 발송 이력을 시간순/유형별/등급별로 조회. 수신 확인 여부 추적 |
| FR-ALT-005 | 알림 템플릿 관리 | 중 | 사고유형별/등급별 알림 메시지 템플릿 등록 및 수정. LLM 자동 생성 메시지 검토 기능 |
| FR-ALT-006 | 에스컬레이션 규칙 | 중 | 1차 알림 미응답 시 상위 관리자 또는 119/112 자동 전달하는 에스컬레이션 규칙 설정 |

## 알림 채널 매핑 기본 규칙

| 위험 등급 | 코드 | 알림 채널 | 수신 대상 | 에스컬레이션 |
|----------|------|----------|----------|-------------|
| 정상(관심) | `normal` | 대시보드 표시만 | 관리자 | 없음 |
| 주의 | `caution` | 대시보드 + 앱 푸시 | 관리자, 작업자 | 없음 |
| 경고 | `warning` | SMS + 앱 푸시 + 조끼 진동 | 관리자, 작업자, 보호자 | 5분 미응답 → 상위관리자 |
| 위험(심각) | `danger` | SMS + 앱 푸시 + 조끼 진동/소리 + 경광등 + E-Call | 전원 + 119/112 | 즉시 E-Call, 2분 미확인 → 119 |

## E-Call 발동 조건
1. **자동 발동**: 위험 등급 '심각' 판정 + 작업자 30초 무응답
2. **수동 발동**: 작업자 모바일 웹 E-Call 버튼 클릭
3. **디바이스 발동**: 차량탑재형 응급키트 전복 감지 시 자동
4. **전송 내용**: GPS 위치(위도/경도), 작업자 정보, 사고 유형 추정, 최근 생체신호

## 화면 구성 가이드

### 알림 설정 화면
```
┌──────────────────────────────────────────────────────┐
│ 알림 설정                                             │
│ [알림 규칙] [수신자 그룹] [E-Call 설정] [템플릿] [이력]  │
├──────────────────────────────────────────────────────┤
│  위험 등급별 알림 채널 매핑                              │
│  ┌──────────┬─────┬──────┬──────┬──────┬──────┐      │
│  │ 등급      │대시보드│앱푸시 │SMS  │조끼  │경광등│      │
│  │ 주의      │ ✅   │ ✅   │     │      │     │      │
│  │ 경고      │ ✅   │ ✅   │ ✅  │ ✅   │     │      │
│  │ 위험      │ ✅   │ ✅   │ ✅  │ ✅   │ ✅  │      │
│  └──────────┴─────┴──────┴──────┴──────┴──────┘      │
├──────────────────────────────────────────────────────┤
│  에스컬레이션 규칙                                     │
│  ① 1차 알림 → [5]분 미응답 → 2차 알림 대상: [상위관리자]│
│  ② 2차 알림 → [2]분 미응답 → 3차 알림 대상: [119/112]  │
│  [+ 규칙 추가]                                        │
├──────────────────────────────────────────────────────┤
│  알림 이력 (최근 7일)                                  │
│  [기간▼] [유형▼] [등급▼] [상태▼] 🔍                   │
│  🔴 02/16 14:32 | 추락위험 | 위험 | E-Call발동 | ✅확인 │
│  🟠 02/16 14:28 | 온열질환 | 경고 | SMS발송   | ✅확인 │
│  🟡 02/16 14:15 | 전복주의 | 주의 | 앱푸시    | ⏳미확인│
└──────────────────────────────────────────────────────┘
```

## 관련 API
| Method | Endpoint | 설명 |
|--------|----------|------|
| POST | `/api/v1/alerts` | 알림 생성 및 발송 |
| GET | `/api/v1/alerts/history?from=&to=&type=&severity=` | 알림 이력 조회 (필터링/페이지네이션) |
| PUT | `/api/v1/alerts/{id}/acknowledge` | 알림 수신 확인 |
| GET/PUT | `/api/v1/alerts/rules` | 알림 규칙 조회/수정 |
| GET/PUT | `/api/v1/alerts/recipients` | 수신자 그룹 관리 |
| POST | `/api/v1/ecall` | E-Call 긴급 호출 발동 |
| GET | `/api/v1/ecall/history` | E-Call 이력 조회 |
| CRUD | `/api/v1/alerts/templates` | 알림 템플릿 CRUD |
| GET/PUT | `/api/v1/alerts/escalation` | 에스컬레이션 규칙 관리 |

## 기술 구현 힌트
- **SMS 발송**: 외부 SMS API 연동 (예: NHN Cloud, Twilio). 발송 결과 콜백 처리
- **앱 푸시**: FCM (Firebase Cloud Messaging) 사용. 모바일 웹 Service Worker로 수신
- **E-Call**: 위치 정보 + 사고 정보를 SMS 메시지로 구성. 119 연동은 별도 프로토콜 협의 필요
- **에스컬레이션**: 백엔드에서 알림 발송 후 타이머 설정. 미확인 시 다음 단계 자동 트리거
- **알림 이력**: 페이지네이션 + 무한 스크롤. 등급별 색상 뱃지로 시각적 구분
