# FR-RPT: 사고 이력 및 분석 리포트

## 모듈 개요
사고 및 아차사고(Near-miss) 이력 관리, 통계 대시보드, 자동 분석 리포트 생성, AI 모델 성능 리포트, 작업자 안전 기록부를 관리하는 모듈.

## 접근 권한
- 시스템 관리자: 전체 이력/통계/리포트 관리
- 농장 관리자: 소속 농장 이력/통계 조회, 리포트 생성
- 지자체 관리자: 관할 지역 통계 조회, 리포트 다운로드

## 기능 요구사항

| ID | 요구사항 | 우선순위 | 상세 설명 |
|----|---------|---------|----------|
| FR-RPT-001 | 사고/아차사고 이력 관리 | 상 | 사고 및 아차사고(Near-miss) 발생 이력을 등록, 조회, 수정. 사고 유형, 발생 일시, 장소, 원인, 조치사항 기록 |
| FR-RPT-002 | 통계 대시보드 | 상 | 기간별/농장별/사고유형별 사고 발생 건수, 위험 알림 추이, 오경보율 등 통계 차트 제공 |
| FR-RPT-003 | 분석 리포트 자동 생성 | 중 | 월간/분기별 안전 분석 리포트를 자동 생성하여 PDF 다운로드 제공 |
| FR-RPT-004 | AI 예측 정확도 리포트 | 중 | 사고유형별 AI 모델의 예측 정확도 추이, 오경보 분석, 개선 제안을 포함한 모델 성능 리포트 |
| FR-RPT-005 | 작업자 안전 기록부 | 중 | 작업자별 누적 위험 노출 이력, 사고 이력, 교육 이수 현황을 통합한 개인 안전 기록부 |

## 사고 이력 데이터 구조

### 사고 등록 필수 입력 항목
| 필드 | 설명 | 타입 |
|------|------|------|
| accident_type | 6대 사고유형 코드 (FALL/ENTANGLE/HEAT/FIRE/ROLLOVER/COLLISION) | enum |
| severity | 심각도 (경미/보통/중대/사망) | enum |
| occurred_at | 발생 일시 | datetime |
| workplace_id | 발생 장소 (농작업장) | FK |
| worker_id | 관련 작업자 | FK (nullable) |
| description | 사고 경위 상세 | text |
| cause | 사고 원인 분석 | text |
| actions_taken | 조치사항 | text |
| is_near_miss | 아차사고 여부 | boolean |
| attachments | 첨부파일 (사진, CCTV 캡처 등) | file[] |

### 통계 대시보드 차트 목록
1. **기간별 사고 발생 추이**: 월별 라인 차트 (사고 + 아차사고)
2. **사고유형별 분포**: 파이 차트 / 도넛 차트
3. **농장별 위험 알림 빈도**: 수평 바 차트
4. **오경보율 추이**: 월별 라인 차트 (전체 알림 대비 False Alarm 비율)
5. **시간대별 사고 분포**: 히트맵 (요일 × 시간)
6. **작업자 연령대별 사고 분포**: 스택 바 차트

## 화면 구성 가이드

### 통계 대시보드
```
┌──────────────────────────────────────────────────────┐
│ 사고 분석 대시보드         기간: [2026.01 ~ 2026.02 ▼] │
├──────────────────────────┬───────────────────────────┤
│ 사고 발생 추이 (월별)      │ 사고유형별 분포            │
│ ┌──────────────────────┐ │ ┌───────────────────────┐ │
│ │ 📈 라인차트           │ │ │ 🍩 도넛차트            │ │
│ │   사고 / 아차사고      │ │ │   추락 35%             │ │
│ │                      │ │ │   온열 25%             │ │
│ └──────────────────────┘ │ │   끼임 15% ...         │ │
│                          │ └───────────────────────┘ │
├──────────────────────────┼───────────────────────────┤
│ 시간대별 사고 히트맵       │ 농장별 위험 알림 빈도       │
│ ┌──────────────────────┐ │ ┌───────────────────────┐ │
│ │ 월 ■■□□■■■□□□□□     │ │ │ 농장A ████████ 42건    │ │
│ │ 화 □■■□□■■□□□□□     │ │ │ 농장B ████████ 38건    │ │
│ │ ...                  │ │ │ 농장C █████ 25건       │ │
│ └──────────────────────┘ │ └───────────────────────┘ │
├──────────────────────────┴───────────────────────────┤
│ [📄 월간 리포트 생성] [📄 분기별 리포트] [📥 CSV 다운로드] │
└──────────────────────────────────────────────────────┘
```

## 관련 API
| Method | Endpoint | 설명 |
|--------|----------|------|
| CRUD | `/api/v1/accidents` | 사고 이력 CRUD |
| GET | `/api/v1/accidents?type=&severity=&from=&to=` | 사고 이력 조회 (필터링) |
| GET | `/api/v1/reports/statistics?from=&to=&group_by=` | 통계 데이터 조회 |
| POST | `/api/v1/reports/generate` | 리포트 자동 생성 (PDF) |
| GET | `/api/v1/reports/{id}/download` | 리포트 다운로드 |
| GET | `/api/v1/reports/ai-performance` | AI 모델 성능 리포트 데이터 |
| GET | `/api/v1/workers/{id}/safety-record` | 작업자 안전 기록부 |

## 기술 구현 힌트
- **통계 차트**: Recharts (LineChart, PieChart, BarChart, Heatmap은 커스텀 구현)
- **PDF 리포트 생성**: 백엔드에서 Puppeteer 또는 PDFKit으로 생성. HTML 템플릿 → PDF 변환
- **CSV 다운로드**: 프론트엔드에서 Papa Parse로 CSV 생성 후 다운로드
- **사고 이력 테이블**: 서버사이드 페이지네이션 + 필터링. 심각도별 색상 뱃지
- **첨부파일**: S3 호환 스토리지 (MinIO) 또는 로컬 파일 시스템. 이미지 썸네일 자동 생성
